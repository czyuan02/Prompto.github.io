<!-- 背景音乐片段：全站加载 -->
<audio id="bgm" preload="auto" autoplay muted loop playsinline>
  <source src="Porsche.mp3" type="audio/mpeg">
</audio>

<button id="music-toggle" aria-label="Toggle background music"
        style="position:fixed; right:16px; bottom:16px; z-index:9999;
               border:none; border-radius:999px; padding:10px 12px;
               box-shadow:0 6px 18px rgba(0,0,0,.15); font-size:18px;
               background:#fff;">🔇</button>

<script>
const audio = document.getElementById('bgm');
const btn   = document.getElementById('music-toggle');

// 读取偏好与上次进度
const savedEnabled = localStorage.getItem('bgmEnabled');   // 'true' | 'false' | null
const savedTime    = parseFloat(localStorage.getItem('bgmTime') || '0');
const savedMuted   = localStorage.getItem('bgmMuted');     // 'true' | 'false' | null
let wantSound      = savedEnabled === 'true';

function setIcon(){
  btn.textContent = (audio.muted || audio.paused) ? '🔇' : '🔊';
}

// 元数据就绪后再设置 currentTime（否则会被忽略）
audio.addEventListener('loadedmetadata', () => {
  if (!isNaN(savedTime) && savedTime > 0 && savedTime < audio.duration) {
    audio.currentTime = savedTime;
  }
});

// 页面可见/离开时保存进度与状态（降低暂停感）
function saveState(){
  try {
    localStorage.setItem('bgmTime', String(audio.currentTime || 0));
    localStorage.setItem('bgmMuted', String(!!audio.muted));
    // bgmEnabled 表示“用户是否希望有声播放”
    localStorage.setItem('bgmEnabled', String(!audio.muted));
  } catch(e) {}
}
document.addEventListener('visibilitychange', saveState);
window.addEventListener('pagehide', saveState);
audio.addEventListener('timeupdate', () => {
  // 轻量保存，间隔保存可选：此处频率由浏览器控制，通常每秒数次
  saveState();
});

function tryAutoplayResume(){
  // 恢复静音/有声倾向
  if (savedMuted !== null) {
    audio.muted = (savedMuted === 'true');
  } else {
    audio.muted = !wantSound;  // 没有记录时默认静音自动播
  }
  // 尝试播放（移动端可能仍要求用户点一下）
  audio.play().then(setIcon).catch(() => {
    // 若被策略拦截，保持静音等待点击
    audio.muted = true;
    setIcon();
  });
}

// 悬浮按钮：控制静音/开声 + 记忆偏好
btn.addEventListener('click', async () => {
  if (audio.paused) {
    audio.muted = false;
    try { await audio.play(); } catch(e) {}
    wantSound = true;
  } else {
    audio.muted = !audio.muted;
    if (!audio.muted && audio.paused) {
      try { await audio.play(); } catch(e) {}
    }
    wantSound = !audio.muted;
  }
  localStorage.setItem('bgmEnabled', String(wantSound));
  setIcon();
});

document.addEventListener('DOMContentLoaded', tryAutoplayResume);
</script>