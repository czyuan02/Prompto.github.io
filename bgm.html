<!-- èƒŒæ™¯éŸ³ä¹ç‰‡æ®µï¼šå…¨ç«™åŠ è½½ -->
<audio id="bgm" preload="auto" autoplay muted loop playsinline>
  <source src="Porsche.mp3" type="audio/mpeg">
</audio>

<button id="music-toggle" aria-label="Toggle background music"
        style="position:fixed; right:16px; bottom:16px; z-index:9999;
               border:none; border-radius:999px; padding:10px 12px;
               box-shadow:0 6px 18px rgba(0,0,0,.15); font-size:18px;
               background:#fff;">ðŸ”‡</button>

<script>
const audio = document.getElementById('bgm');
const btn   = document.getElementById('music-toggle');

// è¯»å–åå¥½ä¸Žä¸Šæ¬¡è¿›åº¦
const savedEnabled = localStorage.getItem('bgmEnabled');   // 'true' | 'false' | null
const savedTime    = parseFloat(localStorage.getItem('bgmTime') || '0');
const savedMuted   = localStorage.getItem('bgmMuted');     // 'true' | 'false' | null
let wantSound      = savedEnabled === 'true';

function setIcon(){
  btn.textContent = (audio.muted || audio.paused) ? 'ðŸ”‡' : 'ðŸ”Š';
}

// å…ƒæ•°æ®å°±ç»ªåŽå†è®¾ç½® currentTimeï¼ˆå¦åˆ™ä¼šè¢«å¿½ç•¥ï¼‰
audio.addEventListener('loadedmetadata', () => {
  if (!isNaN(savedTime) && savedTime > 0 && savedTime < audio.duration) {
    audio.currentTime = savedTime;
  }
});

// é¡µé¢å¯è§/ç¦»å¼€æ—¶ä¿å­˜è¿›åº¦ä¸ŽçŠ¶æ€ï¼ˆé™ä½Žæš‚åœæ„Ÿï¼‰
function saveState(){
  try {
    localStorage.setItem('bgmTime', String(audio.currentTime || 0));
    localStorage.setItem('bgmMuted', String(!!audio.muted));
    // bgmEnabled è¡¨ç¤ºâ€œç”¨æˆ·æ˜¯å¦å¸Œæœ›æœ‰å£°æ’­æ”¾â€
    localStorage.setItem('bgmEnabled', String(!audio.muted));
  } catch(e) {}
}
document.addEventListener('visibilitychange', saveState);
window.addEventListener('pagehide', saveState);
audio.addEventListener('timeupdate', () => {
  // è½»é‡ä¿å­˜ï¼Œé—´éš”ä¿å­˜å¯é€‰ï¼šæ­¤å¤„é¢‘çŽ‡ç”±æµè§ˆå™¨æŽ§åˆ¶ï¼Œé€šå¸¸æ¯ç§’æ•°æ¬¡
  saveState();
});

function tryAutoplayResume(){
  // æ¢å¤é™éŸ³/æœ‰å£°å€¾å‘
  if (savedMuted !== null) {
    audio.muted = (savedMuted === 'true');
  } else {
    audio.muted = !wantSound;  // æ²¡æœ‰è®°å½•æ—¶é»˜è®¤é™éŸ³è‡ªåŠ¨æ’­
  }
  // å°è¯•æ’­æ”¾ï¼ˆç§»åŠ¨ç«¯å¯èƒ½ä»è¦æ±‚ç”¨æˆ·ç‚¹ä¸€ä¸‹ï¼‰
  audio.play().then(setIcon).catch(() => {
    // è‹¥è¢«ç­–ç•¥æ‹¦æˆªï¼Œä¿æŒé™éŸ³ç­‰å¾…ç‚¹å‡»
    audio.muted = true;
    setIcon();
  });
}

// æ‚¬æµ®æŒ‰é’®ï¼šæŽ§åˆ¶é™éŸ³/å¼€å£° + è®°å¿†åå¥½
btn.addEventListener('click', async () => {
  if (audio.paused) {
    audio.muted = false;
    try { await audio.play(); } catch(e) {}
    wantSound = true;
  } else {
    audio.muted = !audio.muted;
    if (!audio.muted && audio.paused) {
      try { await audio.play(); } catch(e) {}
    }
    wantSound = !audio.muted;
  }
  localStorage.setItem('bgmEnabled', String(wantSound));
  setIcon();
});

document.addEventListener('DOMContentLoaded', tryAutoplayResume);
</script>